# Диагностика проблем с лоссами в Diffusion/LoRA-тренировке

## 1. Введение

Инструмент для поиска и подтверждения причин артефактов тайлинга (удвоение шага, «столбики/строки», alias/moire) при замене материалов на стенах. Скрипт строит спектральные и корреляционные карты, считает метрики и сохраняет понятный отчёт (PNG + JSON). Подходит и для одиночных изображений, и для периодического вызова прямо из кода обучения.

## 2. Что диагностируем

1. «Кучкование» артефактов строго по строкам/столбцам очень похоже на сетчатые артефакты апсемплинга (transposed-conv / sub-pixel), известные как checkerboard artifacts. Они возникают из-за неравномерных перекрытий ядер при апсемплинге; типичный фикс — заменить на resize-conv (Nearest/Bilinear → Conv) или подогнать кратность ядра и шага.
<br>***Симптомы:** артефакты идут «по клетке», узор «срывается» вдоль чётных строк/столбцов.*

2. Удвоение шага — классическая путаница фундаментальной частоты с гармониками (модель «садится» на 2f или ½f вместо f), усугубляемая утечкой спектра и краевыми эффектами FFT. Проверяется через ACF/радиальный спектр/цепстр. 
<br>***Симптомы:** «плитка в два раза длиннее/короче», часто зонами; на спектре — пик на 2f сильнее f.*

3. Алиасинг/moire при ресайзе (даунсемплирование без низкочастотной фильтрации) рождает регулярные «усреднённые» ряды/колонки и «неправильные» периоды. Для CNN и диффузий это проявляется как сдвиговая неинвариантность из-за страйдов и пуллинга без антиалиаса (лечится blur-pool/антиалиасом перед даунсэмплом).
<br>***Симптомы:** повторяющиеся ряды/столбцы после даун/ап-скейла; на разных масштабах «срывы» меняют период.*

4. Краевые эффекты в 2D-FFT (предположение периодичности кадра) дают осевой «крест» энергии, что подталкивает модель к осевым деформациям и столбикам/строкам. Лечится аподизацией (окна Ханна/Тьюки) или Periodic-plus-Smooth перед спектральными вычислениями.
<br>***Симптомы:** на 2D-FFT виден «крест» по осям; артефакты растут вдоль строк/столбцов.*

5. Перспектива/анизотропия по стене
<br> ***Симптомы:** удвоение шага «полосами» поперёк направления перспективы; локальный период меняется по ширине/высоте*

   ***Пункты 1 и 3 - скорее всего чушь, т.к. чистый MSE дает совсем другие проблемы, но на всякий случай оставил, вдруг там тоже, что-то обнаружим.***

## 3. Пример запуска

### 3.1. Bash

минимально (без маски/референса; скрипт сам возьмёт всю область):
```
python diag_tiling.py \
  --pred path/to/replaced_wall.jpg \
  --out diag_report/
```
с маской стены:
```
python diag_tiling.py \
  --pred path/to/replaced_wall.jpg \
  --mask path/to/wall_mask.png \
  --out diag_report_masked/
```
с референсом текстуры (лучше тайловый патч 256×256):
```
python diag_tiling.py \
  --pred path/to/replaced_wall.jpg \
  --ref  path/to/reference_tile_patch.png \
  --mask path/to/wall_mask.png \
  --out diag_report_ref/
```

### 3.2. Код
```
from torch.utils.tensorboard import SummaryWriter
import diag_tiling as dt

writer = SummaryWriter("runs/tiling_diag")
global_step = 0
diag_every = 500

for epoch in range(num_epochs):
    for batch in train_loader:
        pred = model(batch["image"], **batch["cond"])   # B×C×H×W, [0,1]
        mask = batch["mask"]                             # B×1×H×W

        loss = ...; loss.backward(); optimizer.step(); optimizer.zero_grad(set_to_none=True)

        if global_step % diag_every == 0:
            out_dir = f"diag_reports/e{epoch:03d}_s{global_step:07d}"
            stats = dt.run_diagnostics_from_tensors(
                pred_bchw=pred.detach(),
                mask_bchw=mask.detach(),
                out_dir=out_dir,
                ref_chw=None,                # или тайловый патч
                global_step=global_step,
                writer=writer,
                tag_prefix="train",
            )
            print("[diag]", stats)
        global_step += 1

writer.close()
```

## 4. Пример возвращаемого значения:
```
{
  "fundamental_radius_bin": 37.9,
  "acf_first_peak_radius_bin": 38.1,
  "E2f_over_Ef": 1.18,
  "Ehalf_over_Ef": 0.87,
  "axis_ratio_at_f": 0.39,
  "shift_mse_dx1": 0.0038,
  "shift_mse_dy1": 0.0040,
  "resize_mse_downUp": 0.0059,
  "resize_delta_r": -1.6,
  "ref_radius_bin": 38.0,

  "band_axis_hint": "rows",
  "band_base_period_px": 27.8,
  "band_row_frac_max": 0.61,
  "band_col_frac_max": 0.19,
  "band_row_max_run": 8,
  "band_col_max_run": 2,
  "band_score": 0.61,
  "band_max_run": 8
}

```

### 4.1. Как это читать

 - ***radial_profile.png*** — профиль лог-амплитуд: красная линия — оценка f*, пунктиром — 0.5f* и 2f*. Если в summary.json метрики E2f_over_Ef или Ehalf_over_Ef > 1, высок риск путаницы фундаментала с гармониками.
 - ***fft_log_hann.png*** vs ***fft_log_nohann.png*** — если без окна виден яркий «крест», а с окном он пропал — у вас краевые артефакты FFT (это часто тянет «столбики/строки»).
 - ***acf.png*** — по первому пику ACF (r≈период) можно проверить, не перескочили ли на 2f/0.5f; ACF менее чувствителен к амплитудным искажениям.
 - ***local_period_px.png*** — карта локального периода: полосы/столбцы выдадут сетку, связанная с ап/даун-семплом, страйдами, стыковкой патчей и т.д.
 - ***axis_ratio_at_f*** — доля энергии на осях в кольце вокруг f. Большие значения ⇒ «осевой крест» доминирует (края, апсемплинг по сетке).
 - ***shift_mse_dx1/dy1*** — чувствительность к сдвигу на 1 px. Высокие значения намекают на сдвиговую неинвариантность из-за алиасинга при даунсемпле; классический фикс — низкочастотная фильтрация (anti-alias) перед сабсэмплом, как в Anti-aliased CNNs / BlurPool.
 - ***resize_mse_downUp*** и ***resize_delta_r*** — sanity-чек на moiré/alias: если MSE велик и r заметно сместился — ваши ресайзы «кормят» полу-частоты.
 - ***local_period_bands.png*** — тепловая карта «полосатости» (доля 2×-периода по строкам/столбцам).
 - ***axis_ratio_at_f*** — доля энергии на осях в кольце вокруг f*. Большие значения ⇒ доминирует «осевой крест» (края/апсемплинг по сетке), что коррелирует с артефактами по строкам/столбцам. Окно Ханна обычно снижает этот показатель.
 - ***resize_mse_downUp*** и ***resize_delta_r*** — sanity-чек на moiré/alias: если MSE велик и r заметно сместился после down→up, ваши ресайзы «кормят» полу-частоты. В torchvision.transforms.Resize для тензоров включайте antialias=True; для PIL при билинейном/бикубическом режимах AA применяется всегда.
 - ***local_period_bands.png*** — тепловая карта «полосатости» (доля 2×-периода по строкам/столбцам). Светлые линии = участки с высокой долей пикселей, где локальный период ≈ 2× базового. Смотрите вместе с band_score и band_max_run в summary.json: высокие значения укажут на «кучкование» удвоенного шага поперёк направления перспективного изменения масштаба (часто связано с деформирующим апсемплингом; полезно заменить deconv на resize→conv).


## 5. Сводная таблица метрик
| Ключ                                  | Что это                                                              | Как читать                                                                                                                                          |
| ------------------------------------- | -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| `fundamental_radius_bin`              | Оценка **f*** (радиус в бинах FFT) по радиальному профилю            | Базовая частота узора                                                                                                                               |
| `acf_first_peak_radius_bin`           | Первый значимый пик **ACF** (через PSD)                              | Должен совпасть с `f*`. Большая разница → риск «гармонической путаницы». Основано на теореме Винера–Хинчина. ([comm.toronto.edu][1])                |
| `E2f_over_Ef`, `Ehalf_over_Ef`        | Энергия в кольцах вокруг **2f***, **0.5f***, нормированная на **f*** | >1 — сеть «садится» на 2f (удвоение шага) или 0.5f (удвоение визуального периода)                                                                   |
| `axis_ratio_at_f`                     | Доля осевой энергии (гориз./верт.) в кольце `f*`                     | Высокие значения → «осевой крест» от краёв/непериодичности кадра; часто коррелирует с «столбиками/строками»                                         |
| `shift_mse_dx1`, `shift_mse_dy1`      | MSE при сдвиге на 1 пиксель по X/Y                                   | Высокая чувствительность → слабая сдвиговая устойчивость из-за даунсэмпла без антиалиаса; лечится low-pass перед subsample (BlurPool). ([arXiv][2]) |
| `resize_mse_downUp`, `resize_delta_r` | Потеря и сдвиг `f*` после даун-ап (AA)                               | Рост → alias/moire от ресайзов; включайте AA                                                                                                        |
| `band_axis_hint`                         | `'rows'` или `'cols'` — где искали полосы (по строкам или по столбцам).                 |
| `band_base_period_px`                    | Базовый период (медиана по `local_period_px`).                                          |
| `band_row_frac_max`, `band_col_frac_max` | Максимальная сглаженная доля 2× по строкам/столбцам (0..1).                             |
| `band_row_max_run`, `band_col_max_run`   | Длина самого длинного кластера «полос» (кол-во строк/столбцов подряд, где доля ≥ 0.35). |
| `band_score`, `band_max_run`             | Итоговый счёт и длина кластера по выбранной оси (`band_axis_hint`).                     |band_score ≥ 0.4…0.5 и/или and_max_run «несколько десятков» — выраженная «полосатость» 2×-периода. Если одновременно высокие E2f/Ef и/или Ehalf/Ef — модель путает фундаментал с гармониками (типично для удвоения шага). (Переопора на гармоники — известная проблема спектральной оценки без аподизации; окна уменьшают вклад ложных пиков.)



[1]: https://www.comm.toronto.edu/frank/notes/wk.pdf "The Wiener-Khinchin Theorem - University of Toronto"
[2]: https://arxiv.org/abs/1904.11486 "Making Convolutional Networks Shift-Invariant Again"
