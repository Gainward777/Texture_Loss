# Диагностика проблем с лоссами в Diffusion/LoRA-тренировке

## 1. Введение

Этот документ описывает систему диагностики повторяющихся артефактов
(двойного тайлинга, вертикальных/горизонтальных "столбиков" ошибок и
др.), возникающих при обучении LoRA и других модификаций диффузионных
моделей. Документация соответствует скрипту-диагносту, генерируемому в
проекте Diffusion Loss.

## 2. Что диагностируем

Скрипт выявляет:

-   Паттерны удвоения шага тайлинга.
-   Склонность ошибок «кучковаться» в строки/столбцы.
-   Локальные высокочастотные шумы, появляющиеся при подмене материала
    стен/поверхностей.
-   Несогласованность распределений латентных признаков между batch-ами.
-   Аномальное поведение лоссов --- всплески, затяжные «полки»,
    расхождение с EMA.
-   Потенциальные проблемы датасета (тайлинг исходных текстур, неверная
    подготовка масок, смещения в кропах).

## 3. Методология диагностики

Диагностика включает:

### 3.1. Анализ лосса

-   Графики `train_loss`, `ema_loss`, `per-step loss smoothing`.
-   Выявление всплесков (\> 3σ относительно скользящего среднего).
-   Проверка корреляции лосса с конкретными батчами/образцами.

### 3.2. Анализ латентов

-   Вычисление статистики латентов до и после UNet.
-   Поиск периодических структур с помощью:
    -   FFT,
    -   автокорреляции,
    -   спектральной плотности.
-   Обнаружение вертикальных/горизонтальных паттернов.

### 3.3. Pixel-space диагностика

-   Рендер исходного изображения / результата.
-   Визуализация разницы (heatmap).
-   Выделение аномалий в 2D через фильтр Собеля + connected-component.

### 3.4. Dataset health checks

-   Обнаружение тайлинга в исходных текстурах (FFT + peak detection).
-   Проверка валидности масок.
-   Проверка перекоса распределений яркости/контраста.

## 4. Функциональность скрипта-диагноста

Скрипт:

-   Загружает логи обучения.
-   Подгружает сохранённые латенты (если доступны).
-   Принимает входные изображения для сравнения.
-   Генерирует отчёт:
    -   графики лосса,\
    -   спектральный анализ,\
    -   карты ошибок,\
    -   индикаторы вероятных причин проблемы.

## 5. Запуск диагностики

### 5.1. CLI запуск

    python diagnose_loss.py \
      --logdir /path/to/logs \
      --images in.png out.png \
      --latents /path/to/latents \
      --report out_report

### 5.2. Запуск внутри тренировки

Внутри цикла обучения:

``` python
from diagnose_loss import LossDiagnostics

diag = LossDiagnostics(config)
if step % config.diag_interval == 0:
    diag.log_step(step, loss, ema_loss, model, batch)
```

## 6. Параметры диагностики

  Параметр            Описание
  ------------------- ----------------------------------------
  `--fft-threshold`   чувствительность к периодическим пикам
  `--spike-sigma`     порог отклонений лосса
  `--heatmap-scale`   усиление уровня карты ошибок
  `--max-images`      число изображений в отчёте

## 7. Интерпретация результатов

### 7.1. Вертикальные/горизонтальные полосы

Причины: - дисбаланс батч-нормализации,\
- периодичность в латентах,\
- аугментации, создающие регулярный паттерн.

### 7.2. Удвоение тайлинга

Причины: - тайлинговые исходники в датасете,\
- ошибки подготовки масок,\
- избыточная регуляризация модели.

### 7.3. Всплески лосса

Причины: - испорченный батч,\
- слишком большой learning rate,\
- разрыв EMA.

## 8. Как расширить диагностику

-   Добавить анализ внимания (cross-attn maps).
-   Сравнение нескольких ckpt.
-   Автоматическое формирование pdf-отчёта.

## 9. Лицензия

MIT License
